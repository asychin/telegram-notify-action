name: Repository Monitoring

on:
  issues:
    types: [opened, closed, reopened, labeled]
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, closed, ready_for_review]
  pull_request_review:
    types: [submitted]
  discussion:
    types: [created, answered]
  schedule:
    # Daily health check at 9:00 UTC
    - cron: "0 9 * * *"
  workflow_dispatch:
    inputs:
      check_type:
        description: "Type of check to perform"
        required: false
        default: "health"
        type: choice
        options:
          - health
          - stats
          - security

jobs:
  issue-notifications:
    name: Issue Notifications
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' || github.event_name == 'issue_comment'
    steps:
      - uses: actions/checkout@v4

      - name: Determine notification type
        id: notification-type
        run: |
          case "${{ github.event.action }}" in
            "opened")
              echo "template=warning" >> $GITHUB_OUTPUT
              echo "emoji=ğŸ›" >> $GITHUB_OUTPUT
              echo "action_text=opened" >> $GITHUB_OUTPUT
              ;;
            "closed")
              echo "template=success" >> $GITHUB_OUTPUT
              echo "emoji=âœ…" >> $GITHUB_OUTPUT
              echo "action_text=closed" >> $GITHUB_OUTPUT
              ;;
            "reopened")
              echo "template=warning" >> $GITHUB_OUTPUT
              echo "emoji=ğŸ”„" >> $GITHUB_OUTPUT
              echo "action_text=reopened" >> $GITHUB_OUTPUT
              ;;
            "labeled")
              echo "template=info" >> $GITHUB_OUTPUT
              echo "emoji=ğŸ·ï¸" >> $GITHUB_OUTPUT
              echo "action_text=labeled" >> $GITHUB_OUTPUT
              ;;
            "created")
              echo "template=info" >> $GITHUB_OUTPUT
              echo "emoji=ğŸ’¬" >> $GITHUB_OUTPUT
              echo "action_text=commented on" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Send issue notification
        if: github.event_name == 'issues'
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          template: ${{ steps.notification-type.outputs.template }}
          language: ru
          parse_mode: "Markdown"
          message: |
            **ğŸ¯ Ğ”ĞµÑ‚Ğ°Ğ»Ğ¸ Issue:**

            **ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** {{action}}
            **ğŸ‘¤ ĞĞ²Ñ‚Ğ¾Ñ€:** `{{author}}`
            **ğŸ·ï¸ ĞœĞµÑ‚ĞºĞ¸:** {{labels}}
            **ğŸ“… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½:** {{createdAt}}

            **ğŸ“ ĞĞ¾Ğ¼ĞµÑ€ Issue:** #{{issueNumber}}
          template_vars: |
            {
              "action": "${{ steps.notification-type.outputs.action_text }}",
              "emoji": "${{ steps.notification-type.outputs.emoji }}"
            }
          inline_keyboard: |
            [
              {"text": "ğŸ‘€ ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Issue", "url": "${{ github.event.issue.html_url }}"},
              {"text": "ğŸ’¬ Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹", "url": "${{ github.event.issue.html_url }}#issuecomment-new"},
              {"text": "âœï¸ Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ", "url": "${{ github.event.issue.html_url }}"}
            ]

      - name: Send comment notification
        if: github.event_name == 'issue_comment'
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          template: info
          parse_mode: "Markdown"
          message: |
            ğŸ’¬ **ĞĞ¾Ğ²Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹ Ğº Issue**

            **ğŸ”¢ #${{ github.event.issue.number }}** - ğŸ“ ${{ github.event.issue.title }}

            **ğŸ‘¤ ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ‚Ğ¾Ñ€:** ${{ github.event.comment.user.login }}
            **ğŸ• Ğ’Ñ€ĞµĞ¼Ñ:** ${{ github.event.comment.created_at }}

            **ğŸ’­ ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹:**
            ${{ github.event.comment.body }}
          inline_keyboard: |
            [
              {"text": "ğŸ‘€ ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ ĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹", "url": "${{ github.event.comment.html_url }}"},
              {"text": "ğŸ“ ĞÑ‚Ğ²ĞµÑ‚Ğ¸Ñ‚ÑŒ", "url": "${{ github.event.issue.html_url }}#issuecomment-new"},
              {"text": "ğŸ”— ĞŸĞµÑ€ĞµĞ¹Ñ‚Ğ¸ Ğº Issue", "url": "${{ github.event.issue.html_url }}"}
            ]

  pr-notifications:
    name: Pull Request Notifications
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'pull_request_review'
    steps:
      - uses: actions/checkout@v4

      - name: Determine PR notification type
        id: pr-notification-type
        run: |
          case "${{ github.event.action }}" in
            "opened")
              echo "template=info" >> $GITHUB_OUTPUT
              echo "emoji=ğŸ”„" >> $GITHUB_OUTPUT
              echo "action_text=opened" >> $GITHUB_OUTPUT
              ;;
            "closed")
              if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
                echo "template=success" >> $GITHUB_OUTPUT
                echo "emoji=ğŸ‰" >> $GITHUB_OUTPUT
                echo "action_text=merged" >> $GITHUB_OUTPUT
              else
                echo "template=warning" >> $GITHUB_OUTPUT
                echo "emoji=âŒ" >> $GITHUB_OUTPUT
                echo "action_text=closed" >> $GITHUB_OUTPUT
              fi
              ;;
            "ready_for_review")
              echo "template=info" >> $GITHUB_OUTPUT
              echo "emoji=ğŸ‘€" >> $GITHUB_OUTPUT
              echo "action_text=marked ready for review" >> $GITHUB_OUTPUT
              ;;
            "submitted")
              echo "template=info" >> $GITHUB_OUTPUT
              echo "emoji=ğŸ“" >> $GITHUB_OUTPUT
              echo "action_text=reviewed" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Send PR notification
        if: github.event_name == 'pull_request'
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          template: deploy # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½ deploy Ğ´Ğ»Ñ PR ĞºĞ°Ğº Ñ€Ğ°Ğ·Ğ²ĞµÑ€Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ ĞºĞ¾Ğ´Ğ°
          language: ru
          parse_mode: "Markdown"
          message: |
            **ğŸ“ˆ Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹:**

            **ğŸŒ¿ Ğ’ĞµÑ‚ĞºĞ°:** `${{ github.event.pull_request.head.ref }}` â†’ `${{ github.event.pull_request.base.ref }}`
            **ğŸ“ Ğ¤Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¾:** ${{ github.event.pull_request.changed_files }}
            **ğŸ“ ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ¾Ğ²:** ${{ github.event.pull_request.commits }}
            **ğŸ“Š Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ:** `+${{ github.event.pull_request.additions }} â• -${{ github.event.pull_request.deletions }} â–`
            **ğŸ‘¤ ĞĞ²Ñ‚Ğ¾Ñ€:** ${{ github.event.pull_request.user.login }}
            **ğŸ“… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½:** ${{ github.event.pull_request.created_at }}

            **ğŸ“ ĞšÑ€Ğ°Ñ‚ĞºĞ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ:**
            *${{ github.event.pull_request.title }}*
          template_vars: |
            {
              "prNumber": "${{ github.event.pull_request.number }}",
              "prTitle": "${{ github.event.pull_request.title }}",
              "author": "${{ github.event.pull_request.user.login }}",
              "deployStatus": "${{ steps.pr-notification-type.outputs.action_text }}",
              "version": "PR#${{ github.event.pull_request.number }}",
              "additions": "${{ github.event.pull_request.additions }}",
              "deletions": "${{ github.event.pull_request.deletions }}",
              "changedFiles": "${{ github.event.pull_request.changed_files }}",
              "commits": "${{ github.event.pull_request.commits }}",
              "headBranch": "${{ github.event.pull_request.head.ref }}",
              "baseBranch": "${{ github.event.pull_request.base.ref }}"
            }
          inline_keyboard: |
            [
              {"text": "ğŸ‘€ ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ PR", "url": "${{ github.event.pull_request.html_url }}"},
              {"text": "ğŸ“ Ğ¡Ğ´ĞµĞ»Ğ°Ñ‚ÑŒ Ñ€ĞµĞ²ÑŒÑ", "url": "${{ github.event.pull_request.html_url }}/files"},
              {"text": "âœ… ĞĞ´Ğ¾Ğ±Ñ€Ğ¸Ñ‚ÑŒ", "url": "${{ github.event.pull_request.html_url }}/files#submit-review"},
              {"text": "ğŸ”„ Ğ¡Ğ»Ğ¸Ñ‚ÑŒ", "url": "${{ github.event.pull_request.html_url }}"}
            ]

      - name: Send review notification
        if: github.event_name == 'pull_request_review'
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          template: info
          parse_mode: "Markdown"
          message: |
            ğŸ“ **ĞĞ±Ğ·Ğ¾Ñ€ Pull Request**

            **ğŸ”¢ #${{ github.event.pull_request.number }}** - ğŸ“‘ ${{ github.event.pull_request.title }}

            **ğŸ‘¤ Ğ ĞµĞ²ÑŒÑĞµÑ€:** ${{ github.event.review.user.login }}
            **ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:** ${{ github.event.review.state == 'approved' && 'âœ… ĞĞ´Ğ¾Ğ±Ñ€ĞµĞ½Ğ¾' || github.event.review.state == 'changes_requested' && 'âŒ Ğ¢Ñ€ĞµĞ±ÑƒÑÑ‚ÑÑ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ' || 'ğŸ’¬ ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹' }}
            **ğŸ• Ğ’Ñ€ĞµĞ¼Ñ:** ${{ github.event.review.submitted_at }}

            ${{ github.event.review.body && format('**ğŸ’­ ĞšĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹ Ğº Ğ¾Ğ±Ğ·Ğ¾Ñ€Ñƒ:**\n{0}', github.event.review.body) || '' }}
          inline_keyboard: |
            [
              {"text": "ğŸ‘€ ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ñ€ĞµĞ²ÑŒÑ", "url": "${{ github.event.review.html_url }}"},
              {"text": "ğŸ“ ĞŸĞµÑ€ĞµĞ¹Ñ‚Ğ¸ Ğº PR", "url": "${{ github.event.pull_request.html_url }}"},
              {"text": "ğŸ’¬ ĞÑ‚Ğ²ĞµÑ‚Ğ¸Ñ‚ÑŒ Ğ½Ğ° Ñ€ĞµĞ²ÑŒÑ", "url": "${{ github.event.pull_request.html_url }}#discussion_r"}
            ]

  discussion-notifications:
    name: Discussion Notifications
    runs-on: ubuntu-latest
    if: github.event_name == 'discussion'
    steps:
      - uses: actions/checkout@v4

      - name: Send discussion notification
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          template: info
          parse_mode: "Markdown"
          message: |
            ğŸ’¬ **ĞĞ¾Ğ²Ğ¾Ğµ Ğ¾Ğ±ÑÑƒĞ¶Ğ´ĞµĞ½Ğ¸Ğµ ${{ github.event.action == 'created' && 'ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¾' || github.event.action == 'answered' && 'Ğ¾Ñ‚Ğ²ĞµÑ‡ĞµĞ½Ğ¾' || github.event.action }}**

            **ğŸ“¢ ${{ github.event.discussion.title }}**

            **ğŸ‘¤ ĞĞ²Ñ‚Ğ¾Ñ€:** ${{ github.event.discussion.user.login }}
            **ğŸ·ï¸ ĞšĞ°Ñ‚ĞµĞ³Ğ¾Ñ€Ğ¸Ñ:** ${{ github.event.discussion.category.name }}
            **ğŸ“… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¾:** ${{ github.event.discussion.created_at }}
            **ğŸ’¬ ĞÑ‚Ğ²ĞµÑ‚Ğ¾Ğ²:** ${{ github.event.discussion.answer_chosen_at && 'âœ… Ğ•ÑÑ‚ÑŒ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚' || 'â“ Ğ–Ğ´ĞµÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°' }}

            **ğŸ“ Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ°Ğ½Ğ¸Ğµ:**
            ${{ github.event.discussion.body }}
          inline_keyboard: |
            [
              {"text": "ğŸ’¬ ĞŸÑ€Ğ¸ÑĞ¾ĞµĞ´Ğ¸Ğ½Ğ¸Ñ‚ÑŒÑÑ Ğº Ğ¾Ğ±ÑÑƒĞ¶Ğ´ĞµĞ½Ğ¸Ñ", "url": "${{ github.event.discussion.html_url }}"},
              {"text": "ğŸ‘ ĞŸĞ¾ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ°ĞºÑ†Ğ¸Ñ", "url": "${{ github.event.discussion.html_url }}"},
              {"text": "âœï¸ ĞÑ‚Ğ²ĞµÑ‚Ğ¸Ñ‚ÑŒ", "url": "${{ github.event.discussion.html_url }}#discussioncomment-new"}
            ]

  health-check:
    name: Repository Health Check
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.check_type == 'health')
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run health checks
        id: health-check
        run: |
          echo "Running repository health checks..."

          # Generate current timestamp
          CURRENT_DATE=$(date -u +"%Y-%m-%d %H:%M UTC")
          echo "current_date=$CURRENT_DATE" >> $GITHUB_OUTPUT

          # Check for security vulnerabilities
          AUDIT_RESULT=$(npm audit --audit-level high --json || echo '{}')
          VULNERABILITIES=$(echo "$AUDIT_RESULT" | jq -r '.metadata.vulnerabilities.total // 0')

          # Check test coverage
          npm run test:coverage > /dev/null 2>&1 || true
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(jq -r '.total.lines.pct' coverage/coverage-summary.json)
          else
            COVERAGE="N/A"
          fi

          # Check for outdated dependencies
          OUTDATED=$(npm outdated --json 2>/dev/null | jq -r 'keys | length' || echo "0")

          # Check repository size
          REPO_SIZE=$(du -sh . | cut -f1)

          echo "vulnerabilities=$VULNERABILITIES" >> $GITHUB_OUTPUT
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "outdated=$OUTDATED" >> $GITHUB_OUTPUT
          echo "repo_size=$REPO_SIZE" >> $GITHUB_OUTPUT

          # Determine health status
          if [ "$VULNERABILITIES" -gt 0 ]; then
            echo "status=warning" >> $GITHUB_OUTPUT
            echo "health_emoji=âš ï¸" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "health_emoji=âœ…" >> $GITHUB_OUTPUT
          fi

      - name: Send health check notification
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          template: test # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½ test Ğ´Ğ»Ñ health check
          language: ru
          parse_mode: "Markdown"
          message: |
            **ğŸ¥ Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡ĞµÑ‚ Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒÑ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ:**

            **ğŸ“… Ğ”Ğ°Ñ‚Ğ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸:** ${{ steps.health-check.outputs.current_date }}
            **ğŸ’¾ Ğ Ğ°Ğ·Ğ¼ĞµÑ€ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ:** `${{ steps.health-check.outputs.repo_size }}`
            **ğŸ¯ ĞĞ±Ñ‰Ğ¸Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ:** ${{ steps.health-check.outputs.status == 'success' && 'âœ… ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğµ Ğ·Ğ´Ğ¾Ñ€Ğ¾Ğ²ÑŒĞµ' || 'âš ï¸ Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ²Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ñ' }}
            **ğŸ“Š ĞŸĞ¾ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ñ‚ĞµÑÑ‚Ğ°Ğ¼Ğ¸:** ${{ steps.health-check.outputs.coverage }}%
            **ğŸ”’ Ğ£ÑĞ·Ğ²Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸:** ${{ steps.health-check.outputs.vulnerabilities == '0' && 'âœ… ĞĞµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾' || format('âš ï¸ {0} Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾', steps.health-check.outputs.vulnerabilities) }}
            **ğŸ“¦ Ğ£ÑÑ‚Ğ°Ñ€ĞµĞ²ÑˆĞ¸Ğµ Ğ¿Ğ°ĞºĞµÑ‚Ñ‹:** ${{ steps.health-check.outputs.outdated == '0' && 'âœ… Ğ’ÑĞµ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹' || format('ğŸ“¦ {0} Ñ‚Ñ€ĞµĞ±ÑƒÑÑ‚ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ', steps.health-check.outputs.outdated) }}

            **ğŸ“‹ Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸:**
            ${{ steps.health-check.outputs.vulnerabilities > 0 && 'â€¢ âš ï¸ ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ñ ÑƒÑĞ·Ğ²Ğ¸Ğ¼Ğ¾ÑÑ‚ÑĞ¼Ğ¸' || 'â€¢ âœ… Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ Ğ² Ğ¿Ğ¾Ñ€ÑĞ´ĞºĞµ' }}
            ${{ steps.health-check.outputs.outdated > 0 && format('â€¢ ğŸ“¦ ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ {0} ÑƒÑÑ‚Ğ°Ñ€ĞµĞ²ÑˆĞ¸Ñ… Ğ¿Ğ°ĞºĞµÑ‚Ğ¾Ğ²', steps.health-check.outputs.outdated) || 'â€¢ âœ… Ğ’ÑĞµ Ğ¿Ğ°ĞºĞµÑ‚Ñ‹ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹' }}
            â€¢ ğŸ“ˆ ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ñ‚ĞµÑÑ‚Ğ°Ğ¼Ğ¸ Ğ²Ñ‹ÑˆĞµ 80%
          template_vars: |
            {
              "testStatus": "${{ steps.health-check.outputs.status == 'success' && 'âœ… Ğ’ÑĞµ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¿Ñ€Ğ¾Ğ¹Ğ´ĞµĞ½Ñ‹' || 'âš ï¸ Ğ•ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹' }}",
              "coverage": "${{ steps.health-check.outputs.coverage }}%",
              "vulnerabilities": "${{ steps.health-check.outputs.vulnerabilities }}",
              "outdatedPackages": "${{ steps.health-check.outputs.outdated }}",
              "repoSize": "${{ steps.health-check.outputs.repo_size }}",
              "healthScore": "${{ steps.health-check.outputs.vulnerabilities == '0' && steps.health-check.outputs.outdated < '5' && '95%' || '70%' }}",
              "checkDate": "${{ steps.health-check.outputs.current_date }}",
              "totalIssues": "${{ steps.health-check.outputs.vulnerabilities }}+${{ steps.health-check.outputs.outdated }}"
            }
          inline_keyboard: |
            [
              {"text": "ğŸ“Š Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ", "url": "${{ github.server_url }}/${{ github.repository }}/actions"},
              {"text": "ğŸ”’ Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ", "url": "${{ github.server_url }}/${{ github.repository }}/security"},
              {"text": "ğŸ“ˆ ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ°", "url": "${{ github.server_url }}/${{ github.repository }}/pulse"},
              {"text": "ğŸ”§ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸", "url": "${{ github.server_url }}/${{ github.repository }}/settings"}
            ]

  repository-stats:
    name: Repository Statistics
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.check_type == 'stats'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history for stats

      - name: Generate repository statistics
        id: stats
        run: |
          # Generate current timestamp
          CURRENT_DATE=$(date -u +"%Y-%m-%d %H:%M UTC")
          echo "current_date=$CURRENT_DATE" >> $GITHUB_OUTPUT

          # Get commit statistics
          TOTAL_COMMITS=$(git rev-list --all --count)
          COMMITS_THIS_MONTH=$(git rev-list --since="1 month ago" --count HEAD)
          CONTRIBUTORS=$(git log --format='%ae' | sort | uniq | wc -l)

          # Get file statistics
          TOTAL_FILES=$(find . -type f -not -path './.git/*' -not -path './node_modules/*' | wc -l)
          CODE_LINES=$(find . -name "*.js" -not -path './node_modules/*' -not -path './.git/*' | xargs wc -l | tail -1 | awk '{print $1}')

          # Get latest release
          LATEST_RELEASE=$(git describe --tags --abbrev=0 2>/dev/null || echo "No releases")

          echo "total_commits=$TOTAL_COMMITS" >> $GITHUB_OUTPUT
          echo "commits_this_month=$COMMITS_THIS_MONTH" >> $GITHUB_OUTPUT
          echo "contributors=$CONTRIBUTORS" >> $GITHUB_OUTPUT
          echo "total_files=$TOTAL_FILES" >> $GITHUB_OUTPUT
          echo "code_lines=$CODE_LINES" >> $GITHUB_OUTPUT
          echo "latest_release=$LATEST_RELEASE" >> $GITHUB_OUTPUT

      - name: Send statistics report
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          template: info
          parse_mode: "Markdown"
          message: |
            ğŸ“Š **ĞÑ‚Ñ‡ĞµÑ‚ Ğ¿Ğ¾ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞµ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ**

            **ğŸ  Ğ ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹:** ${{ github.repository }}
            **ğŸ“… Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½:** ${{ steps.stats.outputs.current_date }}

            **ğŸš€ ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸:**
            â€¢ ğŸ“ Ğ’ÑĞµĞ³Ğ¾ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ¾Ğ²: **${{ steps.stats.outputs.total_commits }}**
            â€¢ ğŸ“ˆ ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ¾Ğ² Ğ·Ğ° Ğ¼ĞµÑÑÑ†: **${{ steps.stats.outputs.commits_this_month }}**
            â€¢ ğŸ‘¥ Ğ£Ñ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²: **${{ steps.stats.outputs.contributors }}**

            **ğŸ’» ĞšĞ¾Ğ´Ğ¾Ğ²Ğ°Ñ Ğ±Ğ°Ğ·Ğ°:**
            â€¢ ğŸ“ Ğ’ÑĞµĞ³Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²: **${{ steps.stats.outputs.total_files }}**
            â€¢ ğŸ“ Ğ¡Ñ‚Ñ€Ğ¾Ğº ĞºĞ¾Ğ´Ğ°: **${{ steps.stats.outputs.code_lines }}**
            â€¢ ğŸ·ï¸ ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ñ€ĞµĞ»Ğ¸Ğ·: **${{ steps.stats.outputs.latest_release }}**

            **ğŸ”— ĞŸĞ¾Ğ»ĞµĞ·Ğ½Ñ‹Ğµ ÑÑÑ‹Ğ»ĞºĞ¸:**
            â€¢ ğŸ‘¥ [Ğ£Ñ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¸](https://github.com/${{ github.repository }}/graphs/contributors)
            â€¢ ğŸ“ˆ [ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ¾Ğ²](https://github.com/${{ github.repository }}/graphs/commit-activity)
            â€¢ ğŸ“Š [Ğ§Ğ°ÑÑ‚Ğ¾Ñ‚Ğ° ĞºĞ¾Ğ´Ğ°](https://github.com/${{ github.repository }}/graphs/code-frequency)
          template_vars: |
            {
              "totalCommits": "${{ steps.stats.outputs.total_commits }}",
              "monthlyCommits": "${{ steps.stats.outputs.commits_this_month }}",
              "contributors": "${{ steps.stats.outputs.contributors }}"
            }
          inline_keyboard: |
            [
              {"text": "ğŸ“ˆ ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ°", "url": "${{ github.server_url }}/${{ github.repository }}/pulse"},
              {"text": "ğŸ‘¥ Ğ£Ñ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¸", "url": "${{ github.server_url }}/${{ github.repository }}/graphs/contributors"},
              {"text": "ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°", "url": "${{ github.server_url }}/${{ github.repository }}/graphs/traffic"},
              {"text": "ğŸ·ï¸ Ğ ĞµĞ»Ğ¸Ğ·Ñ‹", "url": "${{ github.server_url }}/${{ github.repository }}/releases"}
            ]
