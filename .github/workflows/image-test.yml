name: Image Upload Tests - C2PA Detection

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: "Test mode to run"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - c2pa-detection
          - photo-vs-document
          - size-validation
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
    paths:
      - "telegram-notify.js"
      - "test-image.png"
      - ".github/workflows/image-test.yml"

jobs:
  c2pa-metadata-detection:
    name: ğŸ” C2PA Metadata Detection Test
    runs-on: ubuntu-latest
    if: github.event.inputs.test_mode == 'all' || github.event.inputs.test_mode == 'c2pa-detection' || github.event_name != 'workflow_dispatch'

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: âœ… Verify Test Image Exists
        run: |
          if [ ! -f "test-image.png" ]; then
            echo "âŒ Test image not found!"
            exit 1
          fi

          echo "ğŸ“Š Image Analysis:"
          ls -lh test-image.png
          file test-image.png

          # Check for C2PA metadata
          if strings test-image.png | grep -i "c2pa\|jumb" > /dev/null; then
            echo "âœ… C2PA metadata detected in test image"
          else
            echo "â„¹ï¸ No C2PA metadata found"
          fi

      - name: ğŸ§ª Test Photo Upload (Should Auto-Convert to Document)
        uses: ./
        id: photo-test
        continue-on-error: true
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          file_path: "test-image.png"
          file_type: "photo"
          caption: "ğŸ§ª C2PA Test: Photo type (should auto-convert to document)"
          language: "ru"
          max_retries: 2

      - name: ğŸ“Š Photo Test Results
        run: |
          echo "Photo test results:"
          echo "Success: ${{ steps.photo-test.outputs.success }}"
          echo "Message ID: ${{ steps.photo-test.outputs.message_id }}"
          echo "File ID: ${{ steps.photo-test.outputs.file_id }}"
          echo "Retry Count: ${{ steps.photo-test.outputs.retry_count }}"

  document-upload-test:
    name: ğŸ“ Document Upload Test
    runs-on: ubuntu-latest
    if: github.event.inputs.test_mode == 'all' || github.event.inputs.test_mode == 'photo-vs-document' || github.event_name != 'workflow_dispatch'

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ“„ Test Document Upload (Recommended for C2PA)
        uses: ./
        id: document-test
        continue-on-error: true
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          file_path: "test-image.png"
          file_type: "document"
          caption: "ğŸ“„ C2PA Test: Document type (recommended for images with metadata)"
          language: "en"
          max_retries: 2

      - name: ğŸ“Š Document Test Results
        run: |
          echo "Document test results:"
          echo "Success: ${{ steps.document-test.outputs.success }}"
          echo "Message ID: ${{ steps.document-test.outputs.message_id }}"
          echo "File ID: ${{ steps.document-test.outputs.file_id }}"
          echo "Retry Count: ${{ steps.document-test.outputs.retry_count }}"

  size-validation-test:
    name: ğŸ“ File Size Validation Test
    runs-on: ubuntu-latest
    if: github.event.inputs.test_mode == 'all' || github.event.inputs.test_mode == 'size-validation' || github.event_name != 'workflow_dispatch'

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ“ Test Size Validation
        run: |
          echo "ğŸ” File Size Analysis:"

          size_bytes=$(stat -f%z test-image.png 2>/dev/null || stat -c%s test-image.png)
          size_kb=$((size_bytes / 1024))
          size_mb=$((size_bytes / 1024 / 1024))

          echo "File size: ${size_kb}KB (${size_bytes} bytes)"

          # Photo limit: 10MB
          photo_limit_mb=10
          photo_limit_bytes=$((photo_limit_mb * 1024 * 1024))

          # Document limit: 50MB  
          document_limit_mb=50
          document_limit_bytes=$((document_limit_mb * 1024 * 1024))

          # Sticker limit: 512KB
          sticker_limit_kb=512
          sticker_limit_bytes=$((sticker_limit_kb * 1024))

          echo "ğŸ“¤ Photo upload: $( [ $size_bytes -le $photo_limit_bytes ] && echo "âœ… SUPPORTED" || echo "âŒ TOO LARGE" ) (limit: ${photo_limit_mb}MB)"
          echo "ğŸ“ Document upload: $( [ $size_bytes -le $document_limit_bytes ] && echo "âœ… SUPPORTED" || echo "âŒ TOO LARGE" ) (limit: ${document_limit_mb}MB)"
          echo "ğŸ·ï¸ Sticker: $( [ $size_bytes -le $sticker_limit_bytes ] && echo "âœ… SUPPORTED" || echo "âŒ TOO LARGE" ) (limit: ${sticker_limit_kb}KB)"

      - name: ğŸš« Test Sticker Size Rejection
        uses: ./
        id: sticker-test
        continue-on-error: true
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          file_path: "test-image.png"
          file_type: "sticker"
          caption: "ğŸ·ï¸ Sticker test (should fail - file too large)"
          max_retries: 1

      - name: ğŸ“Š Sticker Test Results (Should Fail)
        run: |
          echo "Sticker test results (expected to fail):"
          echo "Success: ${{ steps.sticker-test.outputs.success }}"
          if [ "${{ steps.sticker-test.outputs.success }}" = "false" ]; then
            echo "âœ… Test passed: File correctly rejected for sticker (too large)"
          else
            echo "âŒ Test failed: File should have been rejected for sticker"
          fi

  metadata-analysis:
    name: ğŸ”¬ Detailed Metadata Analysis
    runs-on: ubuntu-latest
    if: github.event.inputs.test_mode == 'all' || github.event.inputs.test_mode == 'c2pa-detection' || github.event_name != 'workflow_dispatch'

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ” Deep Metadata Analysis
        run: |
          echo "ğŸ”¬ DETAILED METADATA ANALYSIS"
          echo "========================================"

          # Basic file info
          echo "ğŸ“ File: test-image.png"
          ls -lh test-image.png
          file test-image.png

          # Check PNG signature
          echo ""
          echo "ğŸ–¼ï¸ PNG Signature Check:"
          xxd -l 8 test-image.png | head -1

          # Look for C2PA/JUMB markers
          echo ""
          echo "ğŸ” C2PA/JUMB Metadata Search:"
          if strings test-image.png | grep -i "c2pa" | head -5; then
            echo "âš ï¸ C2PA metadata found!"
          else
            echo "â„¹ï¸ No C2PA strings found"
          fi

          if strings test-image.png | grep -i "jumb" | head -5; then
            echo "âš ï¸ JUMB metadata found!"
          else
            echo "â„¹ï¸ No JUMB strings found"  
          fi

          # Check for other metadata
          echo ""
          echo "ğŸ“‹ Other Metadata Markers:"
          strings test-image.png | grep -E "(exif|xmp|iptc|tiff)" -i | head -3 || echo "No standard metadata markers found"

          echo ""
          echo "âœ… Analysis complete"

      - name: ğŸ§ª Run Unit Tests for Image Handling
        run: |
          echo "ğŸ§ª Running image-specific unit tests..."
          npm test -- tests/image.test.js --verbose

          echo ""
          echo "ğŸ”— Running integration tests..."
          npm test -- tests/integration.test.js --verbose

  summary:
    name: ğŸ“Š Image Test Summary
    runs-on: ubuntu-latest
    needs:
      [
        c2pa-metadata-detection,
        document-upload-test,
        size-validation-test,
        metadata-analysis,
      ]
    if: always()

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“Š Send Test Summary
        uses: ./
        continue-on-error: true
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          template: ${{ (needs.c2pa-metadata-detection.result == 'success' && needs.document-upload-test.result == 'success' && needs.size-validation-test.result == 'success' && needs.metadata-analysis.result == 'success') && 'success' || 'warning' }}
          language: "ru"
          message: |
            **ğŸ–¼ï¸ Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¾**

            ğŸ“Š **Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹:**
            â€¢ C2PA Detection: ${{ needs.c2pa-metadata-detection.result }}
            â€¢ Document Upload: ${{ needs.document-upload-test.result }}
            â€¢ Size Validation: ${{ needs.size-validation-test.result }}
            â€¢ Metadata Analysis: ${{ needs.metadata-analysis.result }}

            ğŸ” **ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ° Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** Ğ˜Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ñ‚ Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ C2PA
            âœ… **Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:** ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ photo â†’ document
          template_vars: |
            {
              "customMessage": "Ğ¢ĞµÑÑ‚Ñ‹ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ğ¼Ğ¸Ñ‚Ğ° ${{ github.sha }}"
            }
          inline_keyboard: |
            [
              [{"text": "ğŸ“Š Workflow", "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}],
              [{"text": "ğŸ“ Commit", "url": "${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"}]
            ]
