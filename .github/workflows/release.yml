name: Release Notification

on:
  release:
    types: [published, prereleased]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release"
        required: true
        default: "v3.0.0"
      prerelease:
        description: "Is this a prerelease?"
        required: false
        default: false
        type: boolean

jobs:
  release-notification:
    name: Send Release Notification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Send main release notification
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          template: release
          message: |
            ðŸŽ‰ **ÐÐ¾Ð²Ñ‹Ð¹ Ñ€ÐµÐ»Ð¸Ð· Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½!**
            
            **Ð’ÐµÑ€ÑÐ¸Ñ:** {{releaseTag}}
            **ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ:** {{releaseName}}
            **ÐÐ²Ñ‚Ð¾Ñ€:** {{releaseAuthor}}
            **ÐŸÑ€Ðµ-Ñ€ÐµÐ»Ð¸Ð·:** {{isPrerelease}}
            
            ðŸ¢ **Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹:** {{repository}}
            ðŸ‘¤ **Ð’Ð»Ð°Ð´ÐµÐ»ÐµÑ†:** {{repositoryOwner}}
            ðŸ”— **Ð¡ÑÑ‹Ð»ÐºÐ°:** {{releaseUrl}}
            
            ðŸ“Š **Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð·Ð°Ð¿ÑƒÑÐºÐµ:**
            - Workflow: {{workflow}}
            - Ð—Ð°Ð¿ÑƒÑÐº: #{{runNumber}}
            - Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ðµ: {{eventName}}
            - ÐÐºÑ‚Ð¾Ñ€: {{actor}}
            - Ð’Ñ€ÐµÐ¼Ñ: {{triggeredAt}}
            
            ðŸ–¥ï¸ **ÐžÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ:**
            - Runner: {{runnerName}} Ð½Ð° {{runnerOs}}
            - ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð°: {{runnerArch}}
            - Workspace: {{workspace}}
            
            ðŸŒ **GitHub:**
            - Ð¡ÐµÑ€Ð²ÐµÑ€: {{serverUrl}}
            - API: {{apiUrl}}
            
            ðŸ“ **ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ñ€ÐµÐ»Ð¸Ð·Ð°:**
            {{releaseBody}}
          inline_keyboard: |
            [
              {"text": "ðŸ“¥ Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ", "url": "{{releaseUrl}}"},
              {"text": "ðŸ“– Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ", "url": "{{serverUrl}}/{{repository}}/blob/main/README.md"},
              {"text": "ðŸ’¡ ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹", "url": "{{serverUrl}}/{{repository}}/tree/main/examples"}
            ]

      - name: Create detailed release notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # Release {{releaseTag}}

          **Repository:** {{repository}}
          **Released by:** {{actor}}
          **Date:** {{triggeredAt}}
          **Prerelease:** {{isPrerelease}}
          **Runner:** {{runnerName}} ({{runnerOs}}/{{runnerArch}})

          ## Release Information
          - **Tag:** {{releaseTag}}
          - **Name:** {{releaseName}}
          - **Author:** {{releaseAuthor}}
          - **URL:** {{releaseUrl}}

          ## GitHub Context
          - **Repository ID:** {{repositoryId}}
          - **Owner:** {{repositoryOwner}} (ID: {{repositoryOwnerId}})
          - **Workflow:** {{workflow}}
          - **Run:** #{{runNumber}} (ID: {{runId}})
          - **Event:** {{eventName}}
          - **SHA:** {{sha}}
          - **Ref:** {{ref}} ({{refType}})

          ## Environment Details
          - **Actions Environment:** {{actionsEnvironment}}
          - **Environment ID:** {{actionsEnvironmentId}}
          - **Workspace:** {{workspace}}
          - **Server:** {{serverUrl}}
          - **API:** {{apiUrl}}

          ## Release Notes
          {{releaseBody}}

          ## Installation
          ```yaml
          - uses: {{repository}}@{{releaseTag}}
            with:
              telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
              chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
              message: "Your notification message"
          ```

          ## Links
          - [Download]({{releaseUrl}})
          - [Documentation]({{serverUrl}}/{{repository}}/blob/main/README.md)
          - [Examples]({{serverUrl}}/{{repository}}/tree/main/examples)
          EOF

      - name: Send release notes as document
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          file_path: RELEASE_NOTES.md
          file_type: document
          caption: |
            ðŸ“‹ **ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ñ‹Ðµ Ð·Ð°Ð¼ÐµÑ‚ÐºÐ¸ Ðº Ñ€ÐµÐ»Ð¸Ð·Ñƒ**
            
            **Ð’ÐµÑ€ÑÐ¸Ñ:** {{releaseTag}}
            **Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹:** {{repository}}
            **Ð”Ð°Ñ‚Ð°:** {{triggeredAt}}
            **Runner:** {{runnerName}} Ð½Ð° {{runnerOs}}
            
            ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ñ€ÐµÐ»Ð¸Ð·Ðµ Ñ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð¾Ð¼ GitHub Actions

      - name: Notify development team (if prerelease)
        if: github.event.release.prerelease == true
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          template: warning
          message: |
            ðŸš§ **ÐŸÑ€Ðµ-Ñ€ÐµÐ»Ð¸Ð· Ð¾Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½**
            
            **Ð’ÐµÑ€ÑÐ¸Ñ:** {{releaseTag}}
            **ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ:** {{releaseName}}
            **ÐÐ²Ñ‚Ð¾Ñ€:** {{releaseAuthor}}
            
            âš ï¸ Ð­Ñ‚Ð¾ Ð¿Ñ€Ðµ-Ñ€ÐµÐ»Ð¸Ð·! Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ñ‚Ñ‰Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ.
            
            ðŸ¢ **Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹:** {{repository}}
            ðŸ‘¤ **Ð’Ð»Ð°Ð´ÐµÐ»ÐµÑ†:** {{repositoryOwner}}
            ðŸ”— **Ð¡ÑÑ‹Ð»ÐºÐ°:** {{releaseUrl}}
            
            ðŸ“Š **ÐšÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°:**
            - Workflow: {{workflow}}
            - Ð—Ð°Ð¿ÑƒÑÐº: #{{runNumber}}
            - ÐÐºÑ‚Ð¾Ñ€: {{actor}}
            - Runner: {{runnerName}} ({{runnerOs}})
          inline_keyboard: |
            [
              {"text": "ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ", "url": "{{releaseUrl}}"},
              {"text": "ðŸ› Ð¡Ð¾Ð¾Ð±Ñ‰Ð¸Ñ‚ÑŒ Ð¾Ð± Ð¾ÑˆÐ¸Ð±ÐºÐµ", "url": "{{serverUrl}}/{{repository}}/issues/new"}
            ]

  post-release-tasks:
    name: Post-Release Tasks
    runs-on: ubuntu-latest
    needs: release-notification
    if: github.event.release.prerelease != true
    steps:
      - uses: actions/checkout@v4

      - name: Update marketplace listing
        run: |
          echo "Updating GitHub Marketplace listing..."
          echo "Repository: {{repository}}"
          echo "Release: {{releaseTag}}"
          echo "Runner: {{runnerName}} on {{runnerOs}}"
          # Add logic to update marketplace if needed

      - name: Notify success
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          template: success
          message: |
            âœ… **ÐŸÑ€Ð¾Ñ†ÐµÑÑ Ñ€ÐµÐ»Ð¸Ð·Ð° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½**
            
            **Ð’ÐµÑ€ÑÐ¸Ñ:** {{releaseTag}}
            **Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹:** {{repository}}
            **Ð’Ð»Ð°Ð´ÐµÐ»ÐµÑ†:** {{repositoryOwner}}
            
            ðŸ“Š **Ð”ÐµÑ‚Ð°Ð»Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ:**
            - Workflow: {{workflow}}
            - Ð—Ð°Ð´Ð°Ñ‡Ð°: {{job}}
            - Ð—Ð°Ð¿ÑƒÑÐº: #{{runNumber}} (ID: {{runId}})
            - Runner: {{runnerName}} Ð½Ð° {{runnerOs}}
            - ÐÑ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ð°: {{runnerArch}}
            
            ðŸŒ **ÐžÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ:**
            - Actions Environment: {{actionsEnvironment}}
            - Workspace: {{workspace}}
            - Ð’Ñ€ÐµÐ¼Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ: {{triggeredAt}}
            
            ðŸŽ¯ Ð’ÑÐµ Ð¿Ð¾ÑÑ‚-Ñ€ÐµÐ»Ð¸Ð·Ð½Ñ‹Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾.
            Action Ñ‚ÐµÐ¿ÐµÑ€ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð² GitHub Marketplace!
