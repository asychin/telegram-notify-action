name: Release Notification

on:
  release:
    types: [published, prereleased]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release"
        required: true
        default: "v2.0.0"
      prerelease:
        description: "Is this a prerelease?"
        required: false
        default: false
        type: boolean

jobs:
  release-notification:
    name: Send Release Notification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get release info
        id: release-info
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "prerelease=${{ github.event.inputs.prerelease }}" >> $GITHUB_OUTPUT
            echo "release_notes=Manual release triggered via workflow dispatch" >> $GITHUB_OUTPUT
            echo "download_url=https://github.com/${{ github.repository }}/releases/tag/${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
            echo "prerelease=${{ github.event.release.prerelease }}" >> $GITHUB_OUTPUT
            echo "release_notes<<EOF" >> $GITHUB_OUTPUT
            echo "${{ github.event.release.body }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "download_url=${{ github.event.release.html_url }}" >> $GITHUB_OUTPUT
          fi

      - name: Create release asset (changelog)
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # Release ${{ steps.release-info.outputs.version }}

          **Repository:** ${{ github.repository }}
          **Released by:** ${{ github.actor }}
          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Prerelease:** ${{ steps.release-info.outputs.prerelease }}

          ## Release Notes
          ${{ steps.release-info.outputs.release_notes }}

          ## What's Changed
          - Enhanced Telegram notifications with file support
          - Added message templates for different scenarios
          - Implemented retry logic with exponential backoff
          - Added inline keyboard support
          - Comprehensive testing suite
          - Improved error handling and logging

          ## Installation
          ```yaml
          - uses: asychin/telegram-notify-action@${{ steps.release-info.outputs.version }}
            with:
              telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
              chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
              message: "Your notification message"
          ```

          ## Links
          - [Download](${{ steps.release-info.outputs.download_url }})
          - [Documentation](https://github.com/${{ github.repository }}/blob/main/README.md)
          - [Examples](https://github.com/${{ github.repository }}/tree/main/examples)
          EOF

      - name: Send release notification to Telegram
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          template: release
          parse_mode: "Markdown"
          language: ru
          template_vars: |
            {
              "version": "${{ steps.release-info.outputs.version }}",
              "tag": "${{ steps.release-info.outputs.version }}",
              "releaseNotes": "${{ steps.release-info.outputs.release_notes }}",
              "customMessage": "ÐÐ¾Ð²Ñ‹Ð¹ Ñ€ÐµÐ»Ð¸Ð· {{version}} Ð´Ð»Ñ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° {{repositoryName}} Ð¾Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½!"
            }
          message: |
            ðŸŽ‰ **ÐÐ¾Ð²Ñ‹Ð¹ Ñ€ÐµÐ»Ð¸Ð· Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½!**

            **ðŸ·ï¸ Ð’ÐµÑ€ÑÐ¸Ñ:** {{version}}
            **ðŸ  Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹:** {{repository}}
            **ðŸ‘¤ ÐÐ²Ñ‚Ð¾Ñ€ Ñ€ÐµÐ»Ð¸Ð·Ð°:** {{releaseAuthor}}
            **ðŸ“… Ð”Ð°Ñ‚Ð°:** {{releaseCreatedAt}}
            **ðŸ”– Ð¢ÐµÐ³:** {{tag}}
            **ðŸ§ª ÐŸÑ€Ðµ-Ñ€ÐµÐ»Ð¸Ð·:** {{isPrerelease}}
            **ðŸ“ Ð§ÐµÑ€Ð½Ð¾Ð²Ð¸Ðº:** {{isDraft}}

            **âœ¨ ÐšÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð¸Ñ Ð² ÑÑ‚Ð¾Ð¹ Ð²ÐµÑ€ÑÐ¸Ð¸:**
            â€¢ ðŸŽ¯ ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹
            â€¢ ðŸŒ Ð“Ð¾Ñ‚Ð¾Ð²Ñ‹Ðµ URL Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ
            â€¢ ðŸ”„ Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð½Ð°Ñ Ð»Ð¾Ð³Ð¸ÐºÐ° Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð¾Ð²
            â€¢ ðŸ“¤ Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ð°Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ñ„Ð°Ð¹Ð»Ð¾Ð²
            â€¢ ðŸ›¡ï¸ Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸
            â€¢ ðŸ§ª ÐšÐ¾Ð¼Ð¿Ð»ÐµÐºÑÐ½Ð¾Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
            â€¢ ðŸ“– ÐŸÐ¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ð°Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ

            **ðŸ“‹ Ð—Ð°Ð¼ÐµÑ‚ÐºÐ¸ Ðº Ñ€ÐµÐ»Ð¸Ð·Ñƒ:**
            {{releaseNotes}}

            **ðŸš€ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ:**
            ```yaml
            - uses: asychin/telegram-notify-action@{{version}}
              with:
                telegram_token: ${{ '{{' }} secrets.TELEGRAM_BOT_TOKEN {{ '}}' }}
                chat_id: ${{ '{{' }} secrets.TELEGRAM_CHAT_ID {{ '}}' }}
                message: "Your notification message"
            ```
          inline_keyboard: |
            [
              {"text": "ðŸ“¥ Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ€ÐµÐ»Ð¸Ð·", "url": "${{ steps.release-info.outputs.download_url }}"},
              {"text": "ðŸ“– Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ", "url": "https://github.com/${{ github.repository }}/blob/main/README.md"}
            ],
            [
              {"text": "ðŸ’¬ ÐžÐ±ÑÑƒÐ¶Ð´ÐµÐ½Ð¸Ñ", "url": "https://github.com/${{ github.repository }}/discussions"},
              {"text": "ðŸ› Ð¡Ð¾Ð¾Ð±Ñ‰Ð¸Ñ‚ÑŒ Ð¾ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ðµ", "url": "https://github.com/${{ github.repository }}/issues/new"}
            ],
            [
              {"text": "ðŸ  Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹", "url": "https://github.com/${{ github.repository }}"},
              {"text": "ðŸ“‹ Ð’ÑÐµ Ñ€ÐµÐ»Ð¸Ð·Ñ‹", "url": "https://github.com/${{ github.repository }}/releases"}
            ]

      - name: Send release notes as document
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          file_path: RELEASE_NOTES.md
          file_type: document
          parse_mode: "Markdown"
          caption: |
            ðŸ“‹ **ÐŸÐ¾Ð»Ð½Ñ‹Ðµ Ð·Ð°Ð¼ÐµÑ‚ÐºÐ¸ Ðº Ñ€ÐµÐ»Ð¸Ð·Ñƒ**

            **ðŸ·ï¸ Ð’ÐµÑ€ÑÐ¸Ñ:** {{version}}
            **ðŸ  Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹:** {{repository}}
            **ðŸ‘¤ Ð’Ð»Ð°Ð´ÐµÐ»ÐµÑ†:** {{repositoryOwnerName}}
            **ðŸ“… ÐžÐ¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ð½Ð¾:** $(date -u +"%Y-%m-%d %H:%M UTC")
            **ðŸ”– Ð¢ÐµÐ³:** {{tag}}
            **ðŸ‘¤ ÐÐ²Ñ‚Ð¾Ñ€:** {{releaseAuthor}}

            **ðŸ“„ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ñ„Ð°Ð¹Ð»Ð°:**
            â€¢ ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ð¾Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹
            â€¢ Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸ Ð¿Ð¾ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐµ
            â€¢ ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ
            â€¢ Ð¡ÑÑ‹Ð»ÐºÐ¸ Ð½Ð° Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸ÑŽ

            Ð¤Ð°Ð¹Ð» ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð¸ÑÑ‡ÐµÑ€Ð¿Ñ‹Ð²Ð°ÑŽÑ‰ÑƒÑŽ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð½Ð¾Ð²Ð¾Ð¼ Ñ€ÐµÐ»Ð¸Ð·Ðµ {{version}}

      - name: Notify development team (if prerelease)
        if: steps.release-info.outputs.prerelease == 'true'
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_DEV_CHAT_ID }}
          template: warning
          message: |
            ðŸš§ **Prerelease Published**

            A prerelease version ${{ steps.release-info.outputs.version }} has been published.
            Please test thoroughly before promoting to stable release.
          template_vars: |
            {
              "version": "${{ steps.release-info.outputs.version }}"
            }
          inline_keyboard: |
            [
              {"text": "ðŸ§ª Test Release", "url": "${{ steps.release-info.outputs.download_url }}"},
              {"text": "ðŸ› Report Issues", "url": "https://github.com/${{ github.repository }}/issues/new"}
            ]

  post-release-tasks:
    name: Post-Release Tasks
    runs-on: ubuntu-latest
    needs: release-notification
    if: github.event.release.prerelease != true
    steps:
      - uses: actions/checkout@v4

      - name: Update marketplace listing
        run: |
          echo "Updating GitHub Marketplace listing..."
          # Add logic to update marketplace if needed

      - name: Notify success
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          template: success
          message: |
            âœ… **Release Process Completed**

            All post-release tasks have been completed successfully.
            The action is now available on GitHub Marketplace.
          template_vars: |
            {
              "version": "${{ github.event.release.tag_name || github.event.inputs.version }}"
            }
