name: Release Notification

on:
  release:
    types: [published, prereleased]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release"
        required: true
        default: "v2.0.0"
      prerelease:
        description: "Is this a prerelease?"
        required: false
        default: false
        type: boolean

jobs:
  release-notification:
    name: Send Release Notification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get release info
        id: release-info
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "prerelease=${{ github.event.inputs.prerelease }}" >> $GITHUB_OUTPUT
            echo "release_notes=Manual release triggered via workflow dispatch" >> $GITHUB_OUTPUT
            echo "download_url=https://github.com/${{ github.repository }}/releases/tag/${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
            echo "prerelease=${{ github.event.release.prerelease }}" >> $GITHUB_OUTPUT
            echo "release_notes<<EOF" >> $GITHUB_OUTPUT
            echo "${{ github.event.release.body }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "download_url=${{ github.event.release.html_url }}" >> $GITHUB_OUTPUT
          fi

      - name: Create release asset (changelog)
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # Release ${{ steps.release-info.outputs.version }}

          **Repository:** ${{ github.repository }}
          **Released by:** ${{ github.actor }}
          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Prerelease:** ${{ steps.release-info.outputs.prerelease }}

          ## Release Notes
          ${{ steps.release-info.outputs.release_notes }}

          ## What's Changed
          - Enhanced Telegram notifications with file support
          - Added message templates for different scenarios
          - Implemented retry logic with exponential backoff
          - Added inline keyboard support
          - Comprehensive testing suite
          - Improved error handling and logging

          ## Installation
          ```yaml
          - uses: asychin/telegram-notify-action@${{ steps.release-info.outputs.version }}
            with:
              telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
              chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
              message: "Your notification message"
          ```

          ## Links
          - [Download](${{ steps.release-info.outputs.download_url }})
          - [Documentation](https://github.com/${{ github.repository }}/blob/main/README.md)
          - [Examples](https://github.com/${{ github.repository }}/tree/main/examples)
          EOF

      - name: Send release notification to Telegram
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          template: release
          parse_mode: "Markdown"
          language: ru
          template_vars: |
            {
              "version": "${{ steps.release-info.outputs.version }}",
              "tag": "${{ steps.release-info.outputs.version }}",
              "releaseNotes": "${{ steps.release-info.outputs.release_notes }}",
              "customMessage": "Новый релиз {{version}} для проекта {{repositoryName}} опубликован!"
            }
          message: |
            🎉 **Новый релиз доступен!**

            **🏷️ Версия:** {{version}}
            **🏠 Репозиторий:** {{repository}}
            **👤 Автор релиза:** {{releaseAuthor}}
            **📅 Дата:** {{releaseCreatedAt}}
            **🔖 Тег:** {{tag}}
            **🧪 Пре-релиз:** {{isPrerelease}}
            **📝 Черновик:** {{isDraft}}

            **✨ Ключевые улучшения в этой версии:**
            • 🎯 Автоматический контекст событий
            • 🌐 Готовые URL переменные
            • 🔄 Улучшенная логика повторов
            • 📤 Расширенная загрузка файлов
            • 🛡️ Дополнительные функции безопасности
            • 🧪 Комплексное тестирование
            • 📖 Полностью обновленная документация

            **📋 Заметки к релизу:**
            {{releaseNotes}}

            **🚀 Использование:**
            ```yaml
            - uses: asychin/telegram-notify-action@{{version}}
              with:
                telegram_token: ${{ '{{' }} secrets.TELEGRAM_BOT_TOKEN {{ '}}' }}
                chat_id: ${{ '{{' }} secrets.TELEGRAM_CHAT_ID {{ '}}' }}
                message: "Your notification message"
            ```
          inline_keyboard: |
            [
              {"text": "📥 Скачать релиз", "url": "${{ steps.release-info.outputs.download_url }}"},
              {"text": "📖 Документация", "url": "https://github.com/${{ github.repository }}/blob/main/README.md"}
            ],
            [
              {"text": "💬 Обсуждения", "url": "https://github.com/${{ github.repository }}/discussions"},
              {"text": "🐛 Сообщить о проблеме", "url": "https://github.com/${{ github.repository }}/issues/new"}
            ],
            [
              {"text": "🏠 Репозиторий", "url": "https://github.com/${{ github.repository }}"},
              {"text": "📋 Все релизы", "url": "https://github.com/${{ github.repository }}/releases"}
            ]

      - name: Send release notes as document
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          file_path: RELEASE_NOTES.md
          file_type: document
          parse_mode: "Markdown"
          caption: |
            📋 **Полные заметки к релизу**

            **🏷️ Версия:** {{version}}
            **🏠 Репозиторий:** {{repository}}
            **👤 Владелец:** {{repositoryOwnerName}}
            **📅 Опубликовано:** $(date -u +"%Y-%m-%d %H:%M UTC")
            **🔖 Тег:** {{tag}}
            **👤 Автор:** {{releaseAuthor}}

            **📄 Содержимое файла:**
            • Подробное описание изменений
            • Инструкции по установке
            • Примеры использования
            • Ссылки на документацию

            Файл содержит исчерпывающую информацию о новом релизе {{version}}

      - name: Notify development team (if prerelease)
        if: steps.release-info.outputs.prerelease == 'true'
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_DEV_CHAT_ID }}
          template: warning
          message: |
            🚧 **Prerelease Published**

            A prerelease version ${{ steps.release-info.outputs.version }} has been published.
            Please test thoroughly before promoting to stable release.
          template_vars: |
            {
              "version": "${{ steps.release-info.outputs.version }}"
            }
          inline_keyboard: |
            [
              {"text": "🧪 Test Release", "url": "${{ steps.release-info.outputs.download_url }}"},
              {"text": "🐛 Report Issues", "url": "https://github.com/${{ github.repository }}/issues/new"}
            ]

  post-release-tasks:
    name: Post-Release Tasks
    runs-on: ubuntu-latest
    needs: release-notification
    if: github.event.release.prerelease != true
    steps:
      - uses: actions/checkout@v4

      - name: Update marketplace listing
        run: |
          echo "Updating GitHub Marketplace listing..."
          # Add logic to update marketplace if needed

      - name: Notify success
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          template: success
          message: |
            ✅ **Release Process Completed**

            All post-release tasks have been completed successfully.
            The action is now available on GitHub Marketplace.
          template_vars: |
            {
              "version": "${{ github.event.release.tag_name || github.event.inputs.version }}"
            }
