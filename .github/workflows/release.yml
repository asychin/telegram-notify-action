name: Release Notification

on:
  release:
    types: [published, prereleased]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release"
        required: true
        default: "v2.0.0"
      prerelease:
        description: "Is this a prerelease?"
        required: false
        default: false
        type: boolean

jobs:
  release-notification:
    name: Send Release Notification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get release info
        id: release-info
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "prerelease=${{ github.event.inputs.prerelease }}" >> $GITHUB_OUTPUT
            echo "release_notes=Manual release triggered via workflow dispatch" >> $GITHUB_OUTPUT
            echo "download_url=https://github.com/${{ github.repository }}/releases/tag/${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
            echo "prerelease=${{ github.event.release.prerelease }}" >> $GITHUB_OUTPUT
            echo "release_notes<<EOF" >> $GITHUB_OUTPUT
            echo "${{ github.event.release.body }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "download_url=${{ github.event.release.html_url }}" >> $GITHUB_OUTPUT
          fi

      - name: Create release asset (changelog)
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # Release ${{ steps.release-info.outputs.version }}

          **Repository:** ${{ github.repository }}
          **Released by:** ${{ github.actor }}
          **Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Prerelease:** ${{ steps.release-info.outputs.prerelease }}

          ## Release Notes
          ${{ steps.release-info.outputs.release_notes }}

          ## What's Changed
          - Enhanced Telegram notifications with file support
          - Added message templates for different scenarios
          - Implemented retry logic with exponential backoff
          - Added inline keyboard support
          - Comprehensive testing suite
          - Improved error handling and logging

          ## Installation
          ```yaml
          - uses: asychin/telegram-notify-action@${{ steps.release-info.outputs.version }}
            with:
              telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
              chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
              message: "Your notification message"
          ```

          ## Links
          - [Download](${{ steps.release-info.outputs.download_url }})
          - [Documentation](https://github.com/${{ github.repository }}/blob/main/README.md)
          - [Examples](https://github.com/${{ github.repository }}/tree/main/examples)
          EOF

      - name: Send release notification to Telegram
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          template: release  
          parse_mode: "Markdown"
          language: en
          template_vars: |
            {
              "customMessage": "New release ${{ steps.release-info.outputs.version }} for project ${{ github.repository }} published!"
            }
          inline_keyboard: |
            [
              {"text": "📥 Download Release", "url": "${{ steps.release-info.outputs.download_url }}"},
              {"text": "📖 Documentation", "url": "https://github.com/${{ github.repository }}/blob/main/README.md"}
            ],
            [
              {"text": "💬 Discussions", "url": "https://github.com/${{ github.repository }}/discussions"},
              {"text": "🐛 Report Issue", "url": "https://github.com/${{ github.repository }}/issues/new"}
            ],
            [
              {"text": "🏠 Repository", "url": "https://github.com/${{ github.repository }}"},
              {"text": "📋 All Releases", "url": "https://github.com/${{ github.repository }}/releases"}
            ]

      - name: Send release notes as document
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          file_path: RELEASE_NOTES.md
          file_type: document
          parse_mode: "Markdown"
          caption: |
            📋 **Complete Release Notes**

            **🏷️ Version:** ${{ steps.release-info.outputs.version }}
            **🏠 Repository:** ${{ github.repository }}
            **👤 Owner:** ${{ github.repository_owner }}
            **📅 Published:** $(date -u +"%Y-%m-%d %H:%M UTC")
            **🔖 Tag:** ${{ steps.release-info.outputs.version }}
            **👤 Author:** ${{ github.actor }}

            **📄 File Contents:**
            • Detailed description of changes
            • Installation instructions
            • Usage examples
            • Documentation links

            File contains comprehensive information about the new release ${{ steps.release-info.outputs.version }}

      - name: Notify development team (if prerelease)
        if: steps.release-info.outputs.prerelease == 'true'
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_DEV_CHAT_ID }}
          template: warning
          parse_mode: "Markdown"
          language: en
          message: |
            🚧 **Prerelease Published!**

            **🏷️ Version:** {{releaseName}}
            **🏠 Repository:** {{repository}}
            **👤 Author:** {{releaseAuthor}}
            **📅 Published:** {{releaseCreatedAt}}
            **🔖 Tag:** {{releaseTag}}

            **⚠️ Development Team Attention:**
            A prerelease version ${{ steps.release-info.outputs.version }} has been published.

            **📋 Required Actions:**
            • 🧪 Conduct thorough testing
            • 🔍 Check compatibility
            • 📝 Update documentation
            • 🐛 Fix any found bugs
            • ✅ Confirm readiness for stable release

            **📋 Release Notes:**
            {{releaseBody}}

            Please test thoroughly before promoting to stable release.

            **🌿 Branch:** {{refName}}
            **👤 Workflow:** {{workflow}}
          template_vars: |
            {
              "customMessage": "Attention! New prerelease ${{ steps.release-info.outputs.version }} requires team testing"
            }
          inline_keyboard: |
            [
              {"text": "🧪 Test Release", "url": "${{ steps.release-info.outputs.download_url }}"},
              {"text": "📖 Documentation", "url": "https://github.com/${{ github.repository }}/blob/main/README.md"}
            ],
            [
              {"text": "🐛 Report Bug", "url": "https://github.com/${{ github.repository }}/issues/new"},
              {"text": "💬 Discussion", "url": "https://github.com/${{ github.repository }}/discussions"}
            ],
            [
              {"text": "🏠 Repository", "url": "https://github.com/${{ github.repository }}"},
              {"text": "📋 All Releases", "url": "https://github.com/${{ github.repository }}/releases"}
            ]

  post-release-tasks:
    name: Post-Release Tasks
    runs-on: ubuntu-latest
    needs: release-notification
    if: github.event.release.prerelease != true
    steps:
      - uses: actions/checkout@v4

      - name: Update marketplace listing
        run: |
          echo "Updating GitHub Marketplace listing..."
          # Add logic to update marketplace if needed

      - name: Notify success
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          template: success
          message: |
            ✅ **Release Process Completed**

            All post-release tasks have been completed successfully.
            The action is now available on GitHub Marketplace.
          template_vars: |
            {
              "customMessage": "Release process completed successfully for version ${{ github.event.release.tag_name || github.event.inputs.version }}"
            }
