name: Release Notification

on:
  release:
    types: [published, prereleased]
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release"
        required: true
        default: "v3.0.0"
      prerelease:
        description: "Is this a prerelease?"
        required: false
        default: false
        type: boolean

jobs:
  release-notification:
    name: Send Release Notification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Send main release notification
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          template: release
          message: |
            🎉 **Новый релиз доступен!**
            
            **Версия:** {{releaseTag}}
            **Название:** {{releaseName}}
            **Автор:** {{releaseAuthor}}
            **Пре-релиз:** {{isPrerelease}}
            
            🏢 **Репозиторий:** {{repository}}
            👤 **Владелец:** {{repositoryOwner}}
            🔗 **Ссылка:** {{releaseUrl}}
            
            📊 **Информация о запуске:**
            - Workflow: {{workflow}}
            - Запуск: #{{runNumber}}
            - Событие: {{eventName}}
            - Актор: {{actor}}
            - Время: {{triggeredAt}}
            
            🖥️ **Окружение:**
            - Runner: {{runnerName}} на {{runnerOs}}
            - Архитектура: {{runnerArch}}
            - Workspace: {{workspace}}
            
            🌐 **GitHub:**
            - Сервер: {{serverUrl}}
            - API: {{apiUrl}}
            
            📝 **Описание релиза:**
            {{releaseBody}}
          inline_keyboard: |
            [
              {"text": "📥 Скачать", "url": "{{releaseUrl}}"},
              {"text": "📖 Документация", "url": "{{serverUrl}}/{{repository}}/blob/main/README.md"},
              {"text": "💡 Примеры", "url": "{{serverUrl}}/{{repository}}/tree/main/examples"}
            ]

      - name: Create detailed release notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # Release {{releaseTag}}

          **Repository:** {{repository}}
          **Released by:** {{actor}}
          **Date:** {{triggeredAt}}
          **Prerelease:** {{isPrerelease}}
          **Runner:** {{runnerName}} ({{runnerOs}}/{{runnerArch}})

          ## Release Information
          - **Tag:** {{releaseTag}}
          - **Name:** {{releaseName}}
          - **Author:** {{releaseAuthor}}
          - **URL:** {{releaseUrl}}

          ## GitHub Context
          - **Repository ID:** {{repositoryId}}
          - **Owner:** {{repositoryOwner}} (ID: {{repositoryOwnerId}})
          - **Workflow:** {{workflow}}
          - **Run:** #{{runNumber}} (ID: {{runId}})
          - **Event:** {{eventName}}
          - **SHA:** {{sha}}
          - **Ref:** {{ref}} ({{refType}})

          ## Environment Details
          - **Actions Environment:** {{actionsEnvironment}}
          - **Environment ID:** {{actionsEnvironmentId}}
          - **Workspace:** {{workspace}}
          - **Server:** {{serverUrl}}
          - **API:** {{apiUrl}}

          ## Release Notes
          {{releaseBody}}

          ## Installation
          ```yaml
          - uses: {{repository}}@{{releaseTag}}
            with:
              telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
              chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
              message: "Your notification message"
          ```

          ## Links
          - [Download]({{releaseUrl}})
          - [Documentation]({{serverUrl}}/{{repository}}/blob/main/README.md)
          - [Examples]({{serverUrl}}/{{repository}}/tree/main/examples)
          EOF

      - name: Send release notes as document
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          file_path: RELEASE_NOTES.md
          file_type: document
          caption: |
            📋 **Подробные заметки к релизу**
            
            **Версия:** {{releaseTag}}
            **Репозиторий:** {{repository}}
            **Дата:** {{triggeredAt}}
            **Runner:** {{runnerName}} на {{runnerOs}}
            
            Полная информация о релизе с контекстом GitHub Actions

      - name: Notify development team (if prerelease)
        if: github.event.release.prerelease == true
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          template: warning
          message: |
            🚧 **Пре-релиз опубликован**
            
            **Версия:** {{releaseTag}}
            **Название:** {{releaseName}}
            **Автор:** {{releaseAuthor}}
            
            ⚠️ Это пре-релиз! Требуется тщательное тестирование.
            
            🏢 **Репозиторий:** {{repository}}
            👤 **Владелец:** {{repositoryOwner}}
            🔗 **Ссылка:** {{releaseUrl}}
            
            📊 **Контекст запуска:**
            - Workflow: {{workflow}}
            - Запуск: #{{runNumber}}
            - Актор: {{actor}}
            - Runner: {{runnerName}} ({{runnerOs}})
          inline_keyboard: |
            [
              {"text": "🧪 Тестировать", "url": "{{releaseUrl}}"},
              {"text": "🐛 Сообщить об ошибке", "url": "{{serverUrl}}/{{repository}}/issues/new"}
            ]

  post-release-tasks:
    name: Post-Release Tasks
    runs-on: ubuntu-latest
    needs: release-notification
    if: github.event.release.prerelease != true
    steps:
      - uses: actions/checkout@v4

      - name: Update marketplace listing
        run: |
          echo "Updating GitHub Marketplace listing..."
          echo "Repository: {{repository}}"
          echo "Release: {{releaseTag}}"
          echo "Runner: {{runnerName}} on {{runnerOs}}"
          # Add logic to update marketplace if needed

      - name: Notify success
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          template: success
          message: |
            ✅ **Процесс релиза завершен**
            
            **Версия:** {{releaseTag}}
            **Репозиторий:** {{repository}}
            **Владелец:** {{repositoryOwner}}
            
            📊 **Детали выполнения:**
            - Workflow: {{workflow}}
            - Задача: {{job}}
            - Запуск: #{{runNumber}} (ID: {{runId}})
            - Runner: {{runnerName}} на {{runnerOs}}
            - Архитектура: {{runnerArch}}
            
            🌐 **Окружение:**
            - Actions Environment: {{actionsEnvironment}}
            - Workspace: {{workspace}}
            - Время завершения: {{triggeredAt}}
            
            🎯 Все пост-релизные задачи выполнены успешно.
            Action теперь доступен в GitHub Marketplace!
