name: Documentation Testing

on:
  push:
    paths:
      - 'docs/**'
      - 'README.md'
      - '**/*.md'
  pull_request:
    paths:
      - 'docs/**'
      - 'README.md' 
      - '**/*.md'
  workflow_dispatch:

jobs:
  validate-docs:
    name: Validate Documentation
    runs-on: ubuntu-latest
    strategy:
      matrix:
        language: [en, ru, zh]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          npm install -g markdownlint-cli
          npm install -g markdown-link-check

      - name: Validate Markdown syntax (${{ matrix.language }})
        run: |
          case "${{ matrix.language }}" in
            "en")
              markdownlint docs/en/ README.md || exit 1
              ;;
            "ru")  
              markdownlint docs/ru/ || exit 1
              ;;
            "zh")
              markdownlint docs/zh/ || exit 1
              ;;
          esac

      - name: Check for broken links (${{ matrix.language }})
        run: |
          case "${{ matrix.language }}" in
            "en")
              markdown-link-check docs/en/README.md
              markdown-link-check docs/en/TEMPLATE-SYSTEM.md
              ;;
            "ru")
              markdown-link-check docs/ru/README.md  
              markdown-link-check docs/ru/TEMPLATE-SYSTEM.md
              ;;
            "zh")
              markdown-link-check docs/zh/README.md
              markdown-link-check docs/zh/TEMPLATE-SYSTEM.md
              ;;
          esac

      - name: Validate auto-context variables documentation
        if: matrix.language == 'en'
        run: |
          markdown-link-check docs/AUTO-CONTEXT-VARIABLES.md
          
          # Check if all variables from code are documented
          echo "Checking if all auto-context variables are documented..."
          
          # Extract variables from JavaScript code
          grep -o 'this\.githubContext\.\w*' telegram-notify.js | sed 's/this\.githubContext\.//' | sort | uniq > /tmp/code_vars.txt
          
          # Extract variables from documentation  
          grep -o '{{[^}]*}}' docs/AUTO-CONTEXT-VARIABLES.md | sed 's/{{//' | sed 's/}}//' | sort | uniq > /tmp/doc_vars.txt
          
          # Compare lists
          echo "Variables in code:"
          cat /tmp/code_vars.txt
          echo "Variables in documentation:"
          cat /tmp/doc_vars.txt
          
          # Check for missing variables in documentation
          missing_vars=$(comm -23 /tmp/code_vars.txt /tmp/doc_vars.txt)
          if [ ! -z "$missing_vars" ]; then
            echo "‚ùå Missing variables in documentation:"
            echo "$missing_vars"
            exit 1
          else
            echo "‚úÖ All variables are documented"
          fi

      - name: Check translation consistency
        run: |
          echo "Checking translation consistency for ${{ matrix.language }}..."
          
          # Basic file existence check
          case "${{ matrix.language }}" in
            "en")
              test -f docs/en/README.md || (echo "‚ùå Missing docs/en/README.md" && exit 1)
              test -f docs/en/TEMPLATE-SYSTEM.md || (echo "‚ùå Missing docs/en/TEMPLATE-SYSTEM.md" && exit 1)
              ;;
            "ru")
              test -f docs/ru/README.md || (echo "‚ùå Missing docs/ru/README.md" && exit 1) 
              test -f docs/ru/TEMPLATE-SYSTEM.md || (echo "‚ùå Missing docs/ru/TEMPLATE-SYSTEM.md" && exit 1)
              ;;
            "zh")
              test -f docs/zh/README.md || (echo "‚ùå Missing docs/zh/README.md" && exit 1)
              test -f docs/zh/TEMPLATE-SYSTEM.md || (echo "‚ùå Missing docs/zh/TEMPLATE-SYSTEM.md" && exit 1)
              ;;
          esac
          
          echo "‚úÖ Translation files exist for ${{ matrix.language }}"

  notify-results:
    name: Notify Test Results
    runs-on: ubuntu-latest
    needs: validate-docs
    if: always()
    steps:
      - name: Notify success
        if: needs.validate-docs.result == 'success'
        uses: asychin/telegram-notify-action@v3
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          template: success
          message: |
            ‚úÖ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ**
            
            üìö **–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ —è–∑—ã–∫–æ–≤:** –∞–Ω–≥–ª–∏–π—Å–∫–∏–π, —Ä—É—Å—Å–∫–∏–π, –∫–∏—Ç–∞–π—Å–∫–∏–π
            üîç **–ü—Ä–æ–≤–µ—Ä–∫–∏:**
            - –°–∏–Ω—Ç–∞–∫—Å–∏—Å Markdown ‚úÖ
            - –ë–∏—Ç—ã–µ —Å—Å—ã–ª–∫–∏ ‚úÖ
            - –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö ‚úÖ
            - –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–≤–æ–¥–æ–≤ ‚úÖ
            
            üè¢ **–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:** {{repository}}
            üîÑ **Workflow:** {{workflow}}
            üë§ **–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä:** {{actor}}
            üîó **–°—Å—ã–ª–∫–∞:** {{serverUrl}}/{{repository}}/actions/runs/{{runId}}

      - name: Notify failure
        if: needs.validate-docs.result == 'failure'
        uses: asychin/telegram-notify-action@v3
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          template: error
          message: |
            ‚ùå **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–∏–ª–æ—Å—å —Å –æ—à–∏–±–∫–∞–º–∏**
            
            üìö **–Ø–∑—ã–∫–∏:** –∞–Ω–≥–ª–∏–π—Å–∫–∏–π, —Ä—É—Å—Å–∫–∏–π, –∫–∏—Ç–∞–π—Å–∫–∏–π
            üö´ **–°—Ç–∞—Ç—É—Å:** –ï—Å—Ç—å –æ—à–∏–±–∫–∏ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
            
            üè¢ **–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:** {{repository}}
            üîÑ **Workflow:** {{workflow}}
            üë§ **–ò–Ω–∏—Ü–∏–∞—Ç–æ—Ä:** {{actor}}
            üîó **–ò—Å–ø—Ä–∞–≤–∏—Ç—å:** {{serverUrl}}/{{repository}}/actions/runs/{{runId}}
            
            üîç **–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
            - –°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –≤ Markdown
            - –ë–∏—Ç—ã–µ —Å—Å—ã–ª–∫–∏
            - –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
            - –ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–≤–æ–¥–æ–≤