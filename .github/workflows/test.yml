name: ğŸ§ª Test and Validate Action

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      test_scenario:
        description: "ğŸ¯ Test scenario to run"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - basic
          - templates
          - files
          - error-handling

jobs:
  lint:
    name: ğŸ” Lint and Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: ğŸ“¦ Install Dependencies
        run: npm install

      - name: âœ¨ Run ESLint
        run: npm run lint

      - name: ğŸ”’ Security Audit
        run: npm audit --audit-level high

  unit-tests:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [16, 18, 20]
    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ§ª Run Tests with Coverage
        run: npm run test:coverage

      - name: ğŸ“Š Upload Coverage to Codecov
        if: matrix.node-version == '20'
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

  integration-tests:
    name: ğŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]
    if: github.event.inputs.test_scenario == 'all' || github.event.inputs.test_scenario == '' || github.event_name != 'workflow_dispatch'
    strategy:
      matrix:
        test-case:
          - name: "Basic Message"
            template: ""
            message: "ğŸ§ª Basic test message from GitHub Actions"
            file_path: ""
          - name: "Success Template"
            template: "success"
            message: "Integration test completed successfully!"
            file_path: ""
          - name: "Error Template"
            template: "error"
            message: "Simulated error for testing"
            file_path: ""
          - name: "Deploy Template"
            template: "deploy"
            message: ""
            file_path: ""
          - name: "With Inline Keyboard"
            template: ""
            message: "Test with inline keyboard"
            file_path: ""
            keyboard: '[{"text": "âœ… Success", "callback_data": "success"}, {"text": "âŒ Failed", "callback_data": "failed"}]'
    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“„ Create Test File
        if: matrix.test-case.name == 'File Upload'
        run: |
          # Create test file safely without heredoc
          echo "ğŸ“‹ Test file content for GitHub Actions" > test-file.txt
          echo "ğŸ  Repository: ${{ github.repository }}" >> test-file.txt
          echo "ğŸ“ Commit: ${{ github.sha }}" >> test-file.txt
          echo "ğŸ”„ Workflow: ${{ github.workflow }}" >> test-file.txt
          echo "ğŸŒ¿ Branch: ${{ github.head_ref || github.ref_name }}" >> test-file.txt

      - name: ğŸš€ Test ${{ matrix.test-case.name }}
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          message: ${{ matrix.test-case.message }}
          template: ${{ matrix.test-case.template }}
          file_path: ${{ matrix.test-case.file_path }}
          inline_keyboard: ${{ matrix.test-case.keyboard || '' }}
          template_vars: |
            {
              "deployStatus": "successful",
              "testStatus": "passed",
              "coverage": "95%",
              "customMessage": "Enhanced with new features"
            }
          language: en
          max_retries: 2
          retry_delay: 1

  conditional-tests:
    name: âš¡ Conditional Sending Tests
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]
    if: github.event.inputs.test_scenario == 'all' || github.event.inputs.test_scenario == 'error-handling' || github.event_name != 'workflow_dispatch'
    strategy:
      matrix:
        condition:
          - name: "Send on Success Only"
            send_on_success: "true"
            send_on_failure: "false"
            simulate_failure: "false"
          - name: "Send on Failure Only"
            send_on_success: "false"
            send_on_failure: "true"
            simulate_failure: "true"
    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ’¥ Simulate Job Failure
        if: matrix.condition.simulate_failure == 'true'
        run: |
          echo "ğŸ’¥ Simulating failure for testing conditional sending"
          exit 1
        continue-on-error: true
        id: simulate-fail

      - name: ğŸ§ª Test Conditional Sending - ${{ matrix.condition.name }}
        uses: ./
        if: always()
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          parse_mode: "Markdown"
          message: |
            ğŸ§ª **Conditional Test: {{testName}}**

            **ğŸ  Repository:** {{repository}}
            **ğŸŒ¿ Branch:** {{refName}}
            **ğŸ‘¤ Actor:** {{actor}}
            **ğŸ”„ Workflow:** {{workflow}}
            **ğŸ“ Commit:** {{shortSha}}

            **ğŸ“Š Test Results:**
            â€¢ Job Status: {{jobStatus}}
            â€¢ Step Status: {{stepStatus}}
            â€¢ Should send: {{shouldSend}}
          template_vars: |
            {
              "testName": "${{ matrix.condition.name }}",
              "jobStatus": "${{ job.status }}",
              "stepStatus": "${{ steps.simulate-fail.outcome }}",
              "shouldSend": "${{ (matrix.condition.send_on_success == 'true' && job.status == 'success') || (matrix.condition.send_on_failure == 'true' && steps.simulate-fail.outcome == 'failure') }}"
            }
          send_on_success: ${{ matrix.condition.send_on_success }}
          send_on_failure: ${{ matrix.condition.send_on_failure }}
          template: "info"

  file-upload-tests:
    name: ğŸ“ File Upload Tests
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]
    if: github.event.inputs.test_scenario == 'all' || github.event.inputs.test_scenario == 'files' || github.event_name != 'workflow_dispatch'
    strategy:
      matrix:
        file-type:
          - type: "document"
            extension: "txt"
            content: "Test document content\\nGenerated by GitHub Actions\\nFrom file-upload-tests workflow"
          - type: "photo"
            extension: "png"
            # We'll create a simple 1x1 PNG for testing
    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“„ Create Test Document
        if: matrix.file-type.type == 'document'
        run: |
          # Create test document safely without heredoc
          printf '%s\n' "${{ matrix.file-type.content }}" > test-file.${{ matrix.file-type.extension }}
          echo "ğŸ“… Build Date: $(date)" >> test-file.${{ matrix.file-type.extension }}
          echo "ğŸ“ Commit SHA: ${{ github.sha }}" >> test-file.${{ matrix.file-type.extension }}
          echo "ğŸ‘¤ Actor: ${{ github.actor }}" >> test-file.${{ matrix.file-type.extension }}
          echo "ğŸ”„ Workflow: ${{ github.workflow }}" >> test-file.${{ matrix.file-type.extension }}

      - name: ğŸ–¼ï¸ Create Test Image
        if: matrix.file-type.type == 'photo'
        run: |
          # Create a simple 1x1 PNG file for testing (base64 approach - more readable)
          echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==" | base64 -d > test-file.png
          echo "âœ… Created 1x1 PNG test file ($(stat -c%s test-file.png) bytes)"

      - name: ğŸš€ Test File Upload - ${{ matrix.file-type.type }}
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          parse_mode: "Markdown"
          file_path: test-file.${{ matrix.file-type.extension }}
          file_type: ${{ matrix.file-type.type }}
          caption: |
            ğŸ“ **File Upload Test**

            ğŸ“„ **Type:** ${{ matrix.file-type.type }}
            ğŸ  **Repository:** ${{ github.repository }}
            ğŸŒ¿ **Branch:** ${{ github.head_ref || github.ref_name }}
            ğŸ”„ **Workflow:** ${{ github.workflow }}
            ğŸ“ **Commit:** ${{ github.sha }}

  error-handling-tests:
    name: ğŸš¨ Error Handling Tests
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]
    if: github.event.inputs.test_scenario == 'all' || github.event.inputs.test_scenario == 'error-handling' || github.event_name != 'workflow_dispatch'
    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”„ Test Retry Mechanism
        uses: ./
        continue-on-error: true
        with:
          telegram_token: "invalid_token_for_testing"
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          message: "ğŸš¨ This should fail and trigger retry logic"
          max_retries: 2
          retry_delay: 1
        id: retry-test

      - name: âœ… Verify Retry Test Results
        run: |
          if [ "${{ steps.retry-test.outcome }}" != "failure" ]; then
            echo "âŒ Error: Retry test should have failed but didn't"
            exit 1
          fi
          echo "âœ… Retry test failed as expected"

  template-tests:
    name: ğŸ“ Template Tests
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]
    if: github.event.inputs.test_scenario == 'all' || github.event.inputs.test_scenario == 'templates' || github.event_name != 'workflow_dispatch'
    strategy:
      matrix:
        template: [success, error, warning, info, deploy, test, release]
        language: [en, ru]
    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ§ª Test ${{ matrix.template }} template in ${{ matrix.language }}
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          template: ${{ matrix.template }}
          language: ${{ matrix.language }}
          message: "Custom message for ${{ matrix.template }} template"
          template_vars: |
            {
              "deployStatus": "successful",
              "testStatus": "passed",
              "coverage": "95%",
              "customMessage": "Template test for ${{ matrix.template }}"
            }

  security-tests:
    name: ğŸ”’ Security Tests
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]
    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ” Security Audit
        run: npm audit --audit-level moderate

      - name: ğŸ•µï¸ Check for Hardcoded Secrets
        run: |
          if grep -r "bot[0-9]\+:" . --exclude-dir=node_modules --exclude-dir=.git; then
            echo "âŒ Found potential hardcoded bot tokens"
            exit 1
          fi
          echo "âœ… No hardcoded secrets found"

  performance-tests:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]
    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸƒ Test Action Performance
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          template: "test"
          message: "âš¡ Performance test - measuring execution time"
          template_vars: |
            {
              "testStatus": "performance",
              "coverage": "timing"
            }
        id: perf-test

      - name: ğŸ“Š Check Execution Time
        run: |
          echo "âœ… Performance test completed"
          echo "ğŸ“¨ Message ID: ${{ steps.perf-test.outputs.message_id }}"
          echo "ğŸ”„ Retry count: ${{ steps.perf-test.outputs.retry_count }}"

  image-upload-tests:
    name: ğŸ–¼ï¸ Image Upload Tests (C2PA)
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]
    if: github.event.inputs.test_scenario == 'all' || github.event.inputs.test_scenario == 'files' || github.event_name != 'workflow_dispatch'
    strategy:
      matrix:
        test-case:
          - name: "C2PA Photo Auto-Convert"
            file_type: "photo"
            caption: "ğŸ§ª C2PA Test: Should auto-convert to document"
            expected_behavior: "auto-convert"
          - name: "Document Upload (Recommended)"
            file_type: "document"
            caption: "ğŸ“„ Recommended: Document type for C2PA images"
            expected_behavior: "success"
    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ–¼ï¸ Test ${{ matrix.test-case.name }}
        uses: ./
        id: image-test
        continue-on-error: true
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          file_path: "test-image.png"
          file_type: ${{ matrix.test-case.file_type }}
          caption: ${{ matrix.test-case.caption }}
          language: "ru"
          max_retries: 2

      - name: ğŸ“Š Validate Results
        run: |
          echo "ğŸ§ª Test: ${{ matrix.test-case.name }}"
          echo "âœ… Success: ${{ steps.image-test.outputs.success }}"
          echo "ğŸ“„ File ID: ${{ steps.image-test.outputs.file_id }}"
          echo "ğŸ”„ Retry Count: ${{ steps.image-test.outputs.retry_count }}"

  final-notification:
    name: ğŸ“‹ Test Summary
    runs-on: ubuntu-latest
    needs:
      [
        integration-tests,
        conditional-tests,
        file-upload-tests,
        error-handling-tests,
        template-tests,
        security-tests,
        performance-tests,
        image-upload-tests,
      ]
    if: always()
    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“‹ Send Test Summary
        uses: ./
        with:
          telegram_token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          chat_id: ${{ secrets.TELEGRAM_CHAT_ID }}
          parse_mode: "Markdown"
          template: ${{ needs.integration-tests.result == 'success' && needs.conditional-tests.result == 'success' && needs.file-upload-tests.result == 'success' && needs.template-tests.result == 'success' && needs.image-upload-tests.result == 'success' && 'success' || 'error' }}
          message: |
            ğŸ¯ **Test Suite Completed**

            **ğŸ  Repository:** {{repository}}
            **ğŸŒ¿ Branch:** {{refName}}
            **ğŸ‘¤ Actor:** {{actor}}
            **ğŸ”„ Workflow:** {{workflow}}
            **ğŸ“ Commit:** {{shortSha}}

            ğŸ“Š **Results:**
            â€¢ ğŸ”— Integration Tests: ${{ needs.integration-tests.result }}
            â€¢ âš¡ Conditional Tests: ${{ needs.conditional-tests.result }}  
            â€¢ ğŸ“ File Upload Tests: ${{ needs.file-upload-tests.result }}
            â€¢ ğŸš¨ Error Handling: ${{ needs.error-handling-tests.result }}
            â€¢ ğŸ“ Template Tests: ${{ needs.template-tests.result }}
            â€¢ ğŸ”’ Security Tests: ${{ needs.security-tests.result }}
            â€¢ âš¡ Performance Tests: ${{ needs.performance-tests.result }}
            â€¢ ğŸ–¼ï¸ Image Tests (C2PA): ${{ needs.image-upload-tests.result }}
          template_vars: |
            {
              "customMessage": "Complete test suite execution finished - all validation and security checks completed"
            }
          inline_keyboard: |
            [
              [
                {"text": "ğŸ“Š View Workflow", "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"},
                {"text": "ğŸ“ View Commit", "url": "${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"}
              ]
            ]
